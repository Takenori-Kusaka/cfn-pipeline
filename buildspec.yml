version: 0.2

phases:
  install:
    commands:
      - echo Install started on `date`
      - pip3 install cfn-lint
      - pip3 install cfnexec==0.6.0
      - pip3 install taskcat
      - gem install cfn-nag
      - curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/aws-cloudformation/cloudformation-guard/main/install-guard.sh | sh
      - export PATH="$PATH:~/.guard/bin/"
  pre_build:
    commands:
      - echo Install completed on `date`
      - echo Initialize start on `date`
      - python3 start.py -c ./config.yml
      - echo Initialize completed on `date`
      - echo cfn-validate start on `date`
      - aws cloudformation validate-template --template-body file://`python3 get_value.py -c  ./config.yml -k template`
      - echo cfn-validate completed on `date`
      - echo cfn-lint start on `date`
      - cfn-lint `python3 get_value.py -c  ./config.yml -k template`
      - echo cfn-lint completed on `date`
      - echo cfn-nag start on `date`
      - cfn_nag_scan --input-path `python3 get_value.py -c  ./config.yml -k template`
      - echo cfn-lint completed on `date`
      - echo cfn-nag start on `date`
      - cfn-guard check -t `python3 get_value.py -c  ./config.yml -k template` -r ./rule.ruleset
      - echo cfn-nag completed on `date`
      - echo taskcat start on `date`
      - taskcat test run
  build:
    commands:
      - echo taskcat completed on `date`
      - echo deploy start on `date`
      - cfn-exec -n example-stack -i `python3 get_value.py -c  ./config.yml -k template` -p `python3 get_value.py -c  ./config.yml -k parameter`
  post_build:
    commands:
      - echo deploy completed on `date`
      - echo close on `date`
      - python3 close.py -c ./config.yml
